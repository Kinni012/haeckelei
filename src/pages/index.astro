---
import fs from 'node:fs';
import path from 'node:path';
import Layout from '../layouts/Layout.astro';

const imageExtensions = /\.(jpg|jpeg|png|gif|webp|avif)$/i;
const imagesBase = path.join(process.cwd(), 'public', 'images');

function getImagesFromFolder(folderName: string): string[] {
  const dir = path.join(imagesBase, folderName);
  try {
    const files = fs.readdirSync(dir);
    return files
      .filter((f) => imageExtensions.test(f))
      .sort()
      .map((f) => `/images/${folderName}/${f}`);
  } catch {
    return [];
  }
}

const categories = [
  { id: 'spotlight', label: 'Häckelei' },
  { id: 'plants', label: 'Plants' },
  { id: 'animals', label: 'Animals' },
] as const;

const galleryByCategory: Record<string, string[]> = {};
for (const cat of categories) {
  galleryByCategory[cat.id] = getImagesFromFolder(cat.id);
}
---

<Layout title="Haeckelei">
  <main class="home">
    <nav class="menu">
      {categories.map((cat) => (
        <button
          type="button"
          class="menu-btn"
          data-category={cat.id}
          aria-pressed={cat.id === 'spotlight'}
        >
          {cat.label}
        </button>
      ))}
    </nav>

    <section class="gallery-area">
      <!-- Text hier: über den Bildern, neben dem Menü -->
      <div class="home-intro">
        <p> Ich freue mich wenn du mich über die Nummer auf der Visitenkarte über Whatsapp kontaktierst. Gerne mache ich für dich Plüschis von den Bildern in allen möglichen Farben oder individuelle Häckel Ideen für z.B. Geburtstage.</p>
      </div>
      {categories.map((cat) => (
        <div
          class="gallery-panel"
          data-category={cat.id}
          hidden={cat.id !== 'spotlight'}
          role="tabpanel"
        >
          {galleryByCategory[cat.id].length > 0 ? (
            <div class="gallery">
              {galleryByCategory[cat.id].map((src) => (
                <button type="button" class="gallery-item" data-src={src} title="Vergrößern">
                  <img src={src} alt="" loading="lazy" decoding="async" />
                </button>
              ))}
            </div>
          ) : (
            <p class="gallery-empty">Noch keine Bilder in <code>images/{cat.id}/</code>.</p>
          )}
        </div>
      ))}
    </section>
  </main>

  <div id="lightbox" class="lightbox" hidden role="dialog" aria-modal="true" aria-label="Bild vergrößert">
    <button type="button" class="lightbox-close" aria-label="Schließen">&times;</button>
    <img class="lightbox-img" src="" alt="" />
  </div>

  <script>
    document.querySelectorAll('.menu-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const category = (btn as HTMLButtonElement).dataset.category;
        if (!category) return;

        document.querySelectorAll('.menu-btn').forEach((b) => b.setAttribute('aria-pressed', 'false'));
        btn.setAttribute('aria-pressed', 'true');

        document.querySelectorAll('.gallery-panel').forEach((panel) => {
          (panel as HTMLElement).hidden = (panel as HTMLElement).dataset.category !== category;
        });
      });
    });

    const lightbox = document.getElementById('lightbox');
    const lightboxImg = lightbox?.querySelector('.lightbox-img') as HTMLImageElement;
    const lightboxClose = lightbox?.querySelector('.lightbox-close');

    function openLightbox(src: string) {
      if (!lightbox || !lightboxImg) return;
      lightboxImg.src = src;
      lightbox.hidden = false;
      document.body.style.overflow = 'hidden';
      lightboxClose?.focus();
    }

    function closeLightbox() {
      if (!lightbox) return;
      lightbox.hidden = true;
      document.body.style.overflow = '';
    }

    document.querySelectorAll('.gallery-item').forEach((btn) => {
      btn.addEventListener('click', () => {
        const src = (btn as HTMLButtonElement).dataset.src;
        if (src) openLightbox(src);
      });
    });

    lightbox?.addEventListener('click', (e) => {
      if (e.target === lightbox || (e.target as Element).closest('.lightbox-close')) closeLightbox();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && lightbox && !lightbox.hidden) closeLightbox();
    });
  </script>

  <style>
    .home {
      display: grid;
      grid-template-columns: minmax(180px, 220px) 1fr;
      gap: 2rem;
      min-height: 80vh;
      max-width: 1400px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    .home-intro {
      margin-bottom: 1.5rem;
      padding: 1.25rem 1.5rem;
      background: #ebe5d4;
      border-radius: 10px;
      border: 1px solid #ddd4b8;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    }

    .home-intro p {
      margin: 0;
      line-height: 1.6;
      color: #3d3530;
    }

    .menu {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .menu-btn {
      padding: 0.75rem 1rem;
      font-size: 1rem;
      text-align: left;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }

    .menu-btn:hover {
      background: #f5f5f5;
      border-color: #999;
    }

    .menu-btn[aria-pressed="true"] {
      background: #333;
      color: #fff;
      border-color: #333;
    }

    .gallery-area {
      min-width: 0;
    }

    .gallery-panel {
      display: block;
    }

    .gallery-panel[hidden] {
      display: none !important;
    }

    .gallery-empty {
      color: #666;
      padding: 2rem;
    }

    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }

    .gallery-item {
      display: block;
      aspect-ratio: 1;
      overflow: hidden;
      border-radius: 8px;
      background: #eee;
      border: none;
      padding: 0;
      cursor: pointer;
      font: inherit;
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.2s ease;
    }

    .gallery-item:hover img {
      transform: scale(1.03);
    }

    .lightbox {
      position: fixed;
      inset: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      background: rgba(0, 0, 0, 0.9);
      cursor: pointer;
    }

    .lightbox[hidden] {
      display: none !important;
    }

    .lightbox-img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      cursor: default;
    }

    .lightbox-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 2.5rem;
      height: 2.5rem;
      border: none;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      font-size: 1.5rem;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }

    .lightbox-close:hover {
      background: rgba(255, 255, 255, 0.35);
    }

    @media (max-width: 640px) {
      .home {
        grid-template-columns: 1fr;
      }

      .menu {
        flex-direction: row;
        flex-wrap: wrap;
      }

      .menu-btn {
        flex: 1 1 auto;
      }
    }
  </style>
</Layout>
